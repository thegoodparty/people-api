name: Deploy

on:
  push:
    branches: ["develop", "master"]

permissions:
  contents: read
  id-token: write
  actions: read

env:
  AWS_REGION: us-west-2
  IMAGE_URI: 333022194791.dkr.ecr.us-west-2.amazonaws.com/people-api:${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::333022194791:role/github-actions-pulumi-deploy
          aws-region: us-west-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install Pulumi
        uses: pulumi/actions@v6
        with:
          pulumi-version: "^3"

      - run: npm ci

      - name: Build and push Docker image
        run: |
          docker build -t "${IMAGE_URI}" -f deploy/Dockerfile .
          docker push "${IMAGE_URI}"

      - name: Determine deployment context
        id: context
        run: |
          case "${{ github.ref_name }}" in
            develop) echo "environment=dev" >> "$GITHUB_OUTPUT" ;;
            master) echo "environment=prod" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Deploy
        working-directory: deploy
        run: ./deploy.sh ${{ steps.context.outputs.environment }}

      - name: Notify Slack on Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
          # only_mention_if: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
